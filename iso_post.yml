---
- name: Remove the original root fs
  file:
    path: iso_files/arch/x86_64/airootfs.sfs
    state: absent

- name: Recreate the root fs
  command: mksquashfs rootfs_files iso_files/arch/x86_64/airootfs.sfs

- name: Update checksum of root fs
  shell: sha256sum airootfs.sfs > airootfs.sha512
  args:
    chdir: '{{ playbook_dir }}/iso_files/arch/x86_64'

- name: Generate remastered iso
  command: >
    xorriso -as mkisofs
     -iso-level 3
     -full-iso9660-filenames
     -volid "{{ iso_label }}"
     -eltorito-boot isolinux/isolinux.bin
     -eltorito-catalog isolinux/boot.cat
     -no-emul-boot -boot-load-size 4 -boot-info-table
     -isohybrid-mbr iso_files/isolinux/isohdpfx.bin
     -eltorito-alt-boot
     -e EFI/archiso/efiboot.img
     -no-emul-boot -isohybrid-gpt-basdat
     -output "archlinux-{{ iso_version }}-remastered.iso"
     iso_files

- name: Link remastered iso to version-agnostic filenmae
  file:
    dest: '{{ playbook_dir }}/archlinux-remastered.iso'
    state: link
    src: '{{ playbook_dir }}/archlinux-{{ iso_version }}-remastered.iso'
    follow: no
